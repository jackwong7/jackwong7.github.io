---
title: 浮点数的坑
date: 2023-02-09 17:06:47
tags:
- Mysql
---

### 浮点数的有效精度

由图可知, float32的 decimal 是7,float64的 decimal 是16

具体的含义就是整数部分加小数部分能保证的精度范围是 **7**(*单精度*) 或者 **16**(*双精度*), 超过这个范围 就会失去精度

<!--more-->

示例图:

![img](浮点数的坑/IEEE754.png)

### 带来的坑

涉及到大金额资金操作的时候,如果数据库存放的是decimal类型,并且操作精度超过了双精度浮点数的精度,那么就会出现问题

我们以mysql的decimal的数据类型举例

首先准备一个表

```
CREATE TABLE `fund` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `amount` decimal(20,7) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;
```

然后插入一条数据

```
INSERT INTO `fund`(`id`, `amount`) VALUES (1, 0.1234560)
```

那么我们来写一条更新语句

```
UPDATE `fund` SET amount = amount + "10000000000.0000001" WHERE id = 1
```

查询后得到结果,刚好只精确了到了decimal 16

```
10000000000.1234550
```

很显然,这个结果不准确,实际应该得到的结果是

```
10000000000.1234561
```

### 解决方案

因为mysql内部对字符串做了类型转换,所以解决方案就是修改字符串的类型:

```
UPDATE `fund` SET amount = amount + CAST("10000000000.0000001" AS DECIMAL ( 20, 7 )) WHERE id = 1
```

mysql文档: [MySQL :: MySQL 5.7 Reference Manual :: 12.3 Type Conversion in Expression Evaluation](https://dev.mysql.com/doc/refman/5.7/en/type-conversion.html?spm=5176.100239.blogcont47339.5.1FTben)
